<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>EMXH</title>
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <link rel="icon" href="//s3.ax1x.com/2021/02/10/y0Ky0P.png">
    <link rel="stylesheet" type="text/css" href="css/stock.css">
    <!-- 引入 ECharts 文件 -->
    <script src="//lib.baomitu.com/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/echarts@5.0.2/dist/echarts.min.js"></script>
    <script src="config/roma.js"></script>
    <script src="js/numberAnimate.js"></script>
    <script src="js/snabbt.min.js"></script>
    <script src="js/stock.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-stat/dist/ecStat.min.js"></script>

    <style>
        body {
            /* background-color: #f0efd1; */
            background: beige;
        }
    </style>

</head>

<body>

    <div id="mainTip">
    </div>
    <div class="row-fluid" style="min-width: 1440px;">
        <div class="span12">
            <div id="outer">
                <span id="inner-absolute">
                    <p class="text-center"></p>
                    <br>
                    <h1 class="text-center" id="pageTitle"></h1>
                    <h5 class="text-center" id="pageSubTitle"></h5>
                    <img class="" style="height: 130px;
                            float: right; margin-top: -125px; margin-right: 10px;" src="//tva1.sinaimg.cn/large/008eGmZEly1gnzqc43zwmj31bi0hcjv0.jpg" />
                </span>
            </div>
            <br>
            <div class="container" style="max-width: 1440px; width: 1440px;min-width: 1440px;">
                <div class="row">
                    <div class="col-sm-3">
                        <p style="height: 135px;"></p>
                    </div>
                    <div class="col-sm-6">
                    </div>

                    <div id="date">
                        <div id="dateText"></div>
                    </div>

                    <div id="main"></div>
                    <br>
                    <br><br>
                    <br><br><br>
                    <br><br><br>
                    <br><br><br>
                    <br><br><br>
                    <div style="height: 200px;"></div>
                    <div>
                        <a href="/?codes=300896,300999,600009,000423,601318,601012,600519,600436&cost=0.5">
                    ↑↑↑ 点击播放 雪球热股榜 - 2021年02月09日
                </a>
                        <a href="/?codes=BABA,BIDU,hk00700&cost=0.5">
                    ↑↑↑ 点击播放 BAT 股价历史 - 2021年02月09日
                </a>
                        <br>
                        <a href="https://space.bilibili.com/114571152" target="_blank">B站 听投资者说</a>
                    </div>
                    <br>
                    <!-- <img class="wechatQR" src="https://s3.ax1x.com/2021/02/10/yw6pO1.jpg" alt="一杯咖啡">
                    <img class="wechatQR" src="https://s3.ax1x.com/2021/02/10/ywyhWQ.png" alt="公众号引导"> -->
                </div>
            </div>
        </div>
    </div>



    <script type="text/javascript ">
        $(document).ready(function() {

            // 设置合理的坐标
            var mainWidth = $('.container').width() * 1;
            var mainHeight = mainWidth * 0.5625;
            $("#main").height(mainHeight + "px").width(mainWidth + "px");

            var x = $('body').outerWidth() - $('.container').outerWidth();
            x = x < 0 ? 0 : x
            var left = (x) / 2.0 + $('.container').outerWidth() * (1 - 0.20) + 10;
            $('#mainTip').css("left", left + "px");
            var rawTop = $('#main').offset().top + $('#main').height() * 0.12 - 40;
            $('#mainTip').css("top", rawTop + "px");

            // 基于准备好的dom，初始化echarts实例
            var codes = getQueryString("codes");
            codes && (stockCodeArr = codes.split(","))

            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('main'), 'roma', {
                renderer: 'svg'
            });


            Promise.all(getStockInfo(stockCodeArr)).then(r => {
                console.log(r);
                var stockNameMap = new Map();
                var stockSharesMap = new Map();
                var stockMarketValueMap = new Map();

                r.forEach(e => {
                    stockNameMap.set(e.symbol, e.name);
                    stockSharesMap.set(e.name, e.shares / 100000000.0);
                    // 汇率系数
                    var xs = 1.0;
                    var market = e.market;
                    if (market == "HK") {
                        xs = 0.8335;
                    } else if (market == "US") {
                        xs = 6.4622;
                    } else if (market == "UK") {
                        xs = 9.0601;
                    }
                    var mv = e.shares / 100000000.0 * xs;
                    // mv = parseFloat(mv.toFixed(2));
                    stockMarketValueMap.set(e.name, mv);
                })

                // 季度 quarter
                Promise.all(getStockKlineList(stockCodeArr, 'quarter')).then(result => {
                    var maxLen = 0;
                    result.forEach(e => {
                        var d = e.data;
                        if (!e.code) {
                            var symbol = d.symbol;
                            e.code = stockNameMap.get(symbol);
                        }
                        var items = d.items ? d.items : d.times;
                        var len = items.length
                        maxLen = len > maxLen ? len : maxLen;
                    })

                    var data = new Array();

                    result.forEach(e => {
                        var name = e.code;
                        var marketValue = stockMarketValueMap.get(name);
                        var items = e.data.items;
                        var values = new Array();
                        var times = new Array();
                        items.forEach(it => {
                            var value = it.close * marketValue;
                            value = value.toFixed(2);
                            values.push(parseFloat(value));
                            times.push(new Date(it.time));
                        })

                        data.push({
                            code: e.code,
                            values: values,
                            times: times
                        });

                    })


                    // 拟合数据，可以插值解决诸多问题
                    // var dataArr = [...data.values()];
                    // var zoom = 1000.0 * 100000000;
                    // for (let i = 0; i < dataArr.length; i++) {
                    //     var curveArr = [];
                    //     const data = dataArr[i];
                    //     var times = data.times;
                    //     var values = data.values;
                    //     for (let j = 0; j < values.length; j++) {
                    //         const v = data.values[j];
                    //         curveArr.push([
                    //             times[j].getTime() / zoom,
                    //             v
                    //         ]);
                    //     }
                    //     var myRegression = ecStat.regression('polynomial', curveArr, 99);
                    //     console.log(myRegression.expression);
                    //     var points = myRegression.points;

                    //     // 插值
                    //     var newTimes = [];
                    //     var newValues = [];
                    //     for (let j = 0; j < points.length; j++) {
                    //         const p = points[j];
                    //         var stime = p[0];
                    //         var rawTime = times[j];
                    //         var value = p[1];
                    //         newTimes.push(new Date(stime * zoom));
                    //         newValues.push(Math.abs(value));

                    //         for (let k = 0; k < 2 && j < points.length - 1; k++) {
                    //             stime = rawTime.addMonths(1).getTime() / zoom;
                    //             // value = myRegression;
                    //             var cns = myRegression.parameter;
                    //             var sum = 0.0;
                    //             for (let k = 0; k < cns.length; k++) {
                    //                 // 系数
                    //                 const cn = cns[k];
                    //                 sum += cn * Math.pow(stime, k)
                    //             }
                    //             value = sum;
                    //             newTimes.push(new Date(stime * zoom));
                    //             newValues.push(Math.abs(value));

                    //             rawTime = newTimes[newTimes.length - 1];
                    //         }
                    //     }


                    //     data.times = newTimes;
                    //     data.values = newValues;
                    // }

                    var dateDim = 'month';
                    // if (maxLen < 100) {
                    //     dateDim = 'day';
                    // }

                    // if (dateDim == 'month') {
                    print2View(data);
                    // } else {
                    //     Promise.all(getStockKlineList(stockCodeArr, dateDim)).then(result => {
                    //         print2View(result);
                    //     });
                    // }
                });
            });


            function print2View(result) {
                var tb = [
                    ["code", "time", "close"]
                ];
                var stockNames = [];
                result.forEach(e => {
                    var stockName = e.code;
                    if (stockName == undefined) {
                        stockName = stockNameMap.get(e.data.symbol);
                    }
                    stockNames.push(stockName);

                    for (let i = 0; i < e.times.length; i++) {
                        var date = e.times[i];
                        if (!date instanceof Date) {
                            date = parseInt(date);
                        }
                        var close = e.values[i];
                        tb.push([stockName, date, close]);
                    }

                });

                // 19961231 => Map(1) "SZSE000651" => Array(6) ["SZSE000651", 19961231, 76.98, 31607500, 1872172541, 1.610460251046025]
                var map = new Map();

                for (let i = 1; i < tb.length; i++) {
                    const e = tb[i];
                    var stockName = e[0];
                    var d = e[1];
                    var date = d;
                    if (typeof d != "string") {
                        date = dateFormat("YYYYmmdd", d);
                    }
                    var innerMap = map.get(date) || new Map();
                    innerMap.set(stockName, e);
                    map.set(date, innerMap)
                }
                var cur = new Map();
                var res = [
                    ["code", "time", "close"]
                ];
                var arrayObj = Array.from(map);
                arrayObj.sort(function(a, b) {
                    return a[0] - b[0]
                });
                map = new Map(arrayObj.map(i => [i[0], i[1]]));

                // 0: {1960 => Map(2)}
                //     key: 1960
                //     value: Map(2)
                //     [[Entries]]
                //     0: {"中国" => Array(3)}
                //     1: {"印度" => Array(3)}
                // map = new Map(arrayObj.map(i => [i[0], i[1]]));
                // for (let i = 0; i < arrayObj.length; i++) {
                //     const date2Arr = arrayObj[i];
                //     var date = dateFormat("YYYYmmdd", date2Arr[0]);
                // }


                map.forEach(function(value, key) {
                    if (value.size < stockNames.length) {
                        stockNames.forEach(c => {
                            if (value.get(c) && !cur) {
                                var data = clone(cur.get(c));
                                data[1] = key;
                                var stockName = stockNameMap.get(c);
                                value.set(stockName, data);
                            }
                        })
                    }

                    var objs = value.values();
                    for (const it of objs) {
                        res.push(it);
                    }
                    cur = value;
                });

                view(res, map, stockNames);
            }

            function view(raw, map, codes) {
                var prev;
                var cl = 0;
                map.forEach(function(value, key) {
                    // value :{"格力电器" => Array(3)}
                    for (let i = 0; i < value.size; i++) {
                        const e = [...value.values()][i];
                        var length = value.size;
                        if (cl <= length) {
                            cl = length;
                            prev = key;
                        } else {
                            console.log(length);
                            // {"格力电器" => Array(3)}
                            var subMap = map.get(prev);
                            subMap.forEach(function(sv, sk) {
                                if (!value.get(sk)) {
                                    // key: 20200101
                                    var dateInt = parseInt(key);
                                    var date = new Date(dateInt / 10000, dateInt / 100 % 100 - 1, dateInt % 10);
                                    sv[1] = date;
                                    value.set(sv[0], sv);
                                }
                            })
                        }
                    }



                })

                let keys = map.keys();
                let arr = [...keys];

                // 名称 2 股票列表
                var stockNameToStockArrMap = getStockNameToStockArrMap(raw);
                var nameArr = [...stockNameToStockArrMap.keys()];
                var pageTitle;
                var pageSubTitle = "「沉简投资」整理制作"
                if (nameArr.length == 1) {
                    pageTitle = nameArr[0] + "历史走势图";
                } else {
                    pageTitle = nameArr[0] + " vs " + nameArr[1];
                }
                $('#pageTitle').html(pageTitle);
                $('#pageSubTitle').html(pageSubTitle);

                // 生成相关的div节点
                for (let i = 0; i < nameArr.length; i++) {
                    const name = nameArr[i];
                    $("#mainTip").append('<div id="code_' + name + '"></div>');
                }

                // 这里不好，应该过滤前面的就可以
                var initValue = new Map();
                map.forEach(function(value, key) {
                    var length = value.size;
                    if (length < nameArr.length) {
                        // name, time, close
                        var infoArr = [...value.values()][0];
                        var sname = infoArr[0];
                        for (let i = 0; i < nameArr.length; i++) {
                            const name = nameArr[i];
                            if (name != sname && !value.has(name)) {
                                // 初始值
                                var initV = initValue.get(name);
                                var v = initV == undefined ? 0 : '-';
                                value.set(name, [name, infoArr[1], v]);
                                initValue.set(name, 1);
                            }
                        }
                    }
                });
                // var filteredItems = map.filter(function (item) {
                //     return value.size == nameArr.length;
                // });


                var seriesList = [];
                var field = '价格';
                var lineWidth = 3;
                for (let i = 0; i < nameArr.length; i++) {
                    const key = nameArr[i];
                    seriesList.push({
                        type: 'line',
                        name: key,
                        showSymbol: false,
                        hoverAnimation: false,
                        smooth: 0.06,
                        sampling: 'average',
                        endLabel: {
                            valueAnimation: true,
                            show: true,
                            color: 'inherit',
                            connectNulls: false,

                            fontSize: 50,
                            // fontWeight: 'bolder',
                            formatter: function(params) {
                                try {
                                    var v = params.value[1];
                                    if (v <= 0 || v == '-') {
                                        return "";
                                    }
                                    var text2 = params.data.value[4].substr(0, 4);
                                    if (params.componentIndex == 0) {
                                        document.getElementById('dateText').innerHTML = text2;
                                    }
                                    var value = params.data.value[1];
                                    var v = params.value[1];
                                    if (v <= 0) {
                                        return "";
                                    }
                                    return params.value[2] + ' ' + v;
                                } catch (error) {
                                    console.log(error);
                                }
                            }
                        },
                        data: new Array(),
                        itemStyle: {
                            normal: {
                                lineStyle: {
                                    width: lineWidth // 0.1的线条是非常细的了
                                },
                                areaStyle: {
                                    type: 'default',
                                },
                            },

                        },

                        areaStyle: {
                            normal: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: '#eb64fb'
                                }, {
                                    offset: 1,
                                    color: '#3fbbff0d'
                                }], false),
                            }
                        },
                    });
                }

                // 打印
                console.log(["NT", ...map.keys()].join("\t"));
                for (let i = 0; i < nameArr.length; i++) {
                    const name = nameArr[i];
                    var infos = [...map.values()];
                    var closes = [name];
                    for (let j = 0; j < infos.length; j++) {
                        const infoMap = infos[j];
                        var close = infoMap.get(name)[2];
                        closes.push(close);
                    }
                    console.log(closes.join("\t"));
                }


                // 腾讯科技->Arr
                var count = 5 < map.size ? 5 : map.size;
                var seriesMap = new Map(seriesList.map(i => [i.name, i.data]));
                for (let i = 0; i < count; i++) {
                    var valueArr = [...map.values()]
                    var oneDayDataMap = valueArr[i];

                    oneDayDataMap.forEach(function(value, key) {
                        // value:[0: "腾讯控股", 1: 20040601, 2: 0.813]
                        var curArr = seriesMap.get(key);
                        var itTime = value[1];
                        // curArr.push(
                        //     [itTime, value[2], value[0], curArr.length]
                        // );

                        var now;
                        if (typeof itTime == "string") {
                            var dateInt = parseInt(itTime);
                            var date = new Date(dateInt / 10000, dateInt / 100 % 100 - 1, dateInt % 10);
                            now = date;
                        } else {
                            now = new Date(itTime);
                        }
                        var dateStr = [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/');
                        var obj = {
                            name: now.toString(),
                            value: [
                                now,
                                value[2],
                                value[0],
                                curArr.length,
                                dateStr
                            ]
                        };
                        curArr.push(obj);
                    });
                }




                var colors = ['#FD2446', '#248EFD', '#C916F2', '#6669B1'];

                var cost = getQueryString("cost", 1);
                var duration = 1000 * cost;

                option = {
                    title: {
                        text: '听投资者说 股票排行榜',
                        subtext: '股价走势图',
                        subtextStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 25,
                        },
                        textStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 40,
                        },
                        left: "center",
                        // top: "100",
                        show: false
                    },
                    xAxis: {
                        name: '',
                        type: 'time',
                        splitLine: {
                            show: false
                        },
                        // boundaryGap: [0, '20%'],
                        // max: function(value) {
                        //     return value.max * 1.15;
                        // }
                        axisLabel: {
                            margin: 10,
                            formatter: {
                                // 一年的第一个月显示年度信息和月份信息
                                year: '{yearStyle|{yyyy}}',
                                month: '{monthStyle|{MMM}}'
                            },
                            rich: {
                                yearStyle: {
                                    // 让年度信息更醒目
                                    // color: '#000',
                                    fontSize: 22,
                                },
                                monthStyle: {
                                    color: '#999'
                                }
                            }
                        },
                        axisLine: {
                            show: true,
                            symbolSize: [10, 15],
                            lineStyle: {
                                width: 3,

                                color: 'black'
                            },
                            opacity: 1,
                            zlevel: 99
                        },
                        axisTick: {
                            show: true,
                            length: 10,
                            lineStyle: {
                                color: 'black',
                                width: 3.4,
                                opacity: 0.5,
                            },
                            zlevel: 98,
                            margin: 45,
                        },

                    },
                    yAxis: [{
                        scale: false,
                        minInterval: 1,
                        axisLabel: {
                            show: true,
                            formatter: '{value}',
                            fontSize: 22,
                            margin: 18,
                            fontSize: 20,
                        },
                        position: 'left',
                        // offset: -7,
                        type: 'value',
                        name: '市值/亿RMB',
                        nameTextStyle: {
                            color: 'black',
                            fontSize: 30,
                            align: "center",
                            padding: [0, 0, 20, 40],
                        },
                        splitLine: {
                            show: false
                        },
                        axisLine: {
                            show: true,
                            symbolSize: [10, 15],
                            lineStyle: {
                                width: 3,

                                color: 'black'
                            },
                            opacity: 1,
                            zlevel: 99
                        },
                        axisTick: {
                            show: true,
                            length: 15,
                            lineStyle: {
                                color: 'black',
                                width: 3.4,
                                opacity: 0.5,
                            },
                            zlevel: 98,
                            margin: 45,
                        },

                        zlevel: 100,
                        axisPointer: {
                            show: true,
                            type: 'line',
                            lineStyle: {
                                color: '#eee'
                            }
                        },

                        max: function(params) {
                            // if (params.max < 800) {
                            //     return 1000;
                            // }
                            return Math.round(params.max * 1.3);
                        }
                    }],
                    grid: {
                        top: '12%',
                        left: '10%',
                        right: '20%',
                        bottom: '6%',
                        containLabel: false,
                    },
                    series: seriesList,
                    animationDuration: 10 * duration,
                    animationEasing: 'linear',
                    animationDurationUpdate: 1 * duration,
                    animationEasingUpdate: 'linear',
                    // animationDelayUpdate: function(idx) {
                    //     // 越往后的数据延迟越大
                    //     return idx * 100;
                    // },
                };

                try {
                    var object = myChart.setOption(option);
                    myChart
                } catch (error) {
                    console.log(error);
                }


                var i = count;
                var moveTime = 1;
                setTimeout(() => {
                    var st = setInterval(() => {
                        var valueArr = [...map.values()]
                        var oneDayDataMap = valueArr[i];
                        i++;
                        if (!oneDayDataMap) {
                            clearInterval(st);
                            return;
                        }
                        oneDayDataMap.forEach(function(value, key) {
                            // value:[0: "腾讯控股", 1: 20040601, 2: 0.813]
                            var curArr = seriesMap.get(key);
                            var itTime = value[1];
                            // curArr.push(
                            //     [itTime, value[2], value[0], curArr.length]
                            // );

                            var now;
                            if (typeof itTime == "string") {
                                var dateInt = parseInt(itTime);
                                var date = new Date(dateInt / 10000, dateInt / 100 % 100 - 1, dateInt % 10);
                                now = date;
                            } else {
                                now = new Date(itTime);
                            }
                            var dateStr = [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/');

                            var length = curArr.length;

                            var obj = {
                                name: now.toString(),
                                value: [
                                    now,
                                    value[2],
                                    value[0],
                                    length,
                                    dateStr
                                ]
                            };
                            curArr.push(obj);
                            if (curArr.length > 80) {
                                curArr.shift();
                            }
                            // curArr
                        });

                        for (let j = 0; j < seriesList.length; j++) {
                            const se = seriesList[j];
                            se.endLabel.formatter = function(params) {
                                var v = params.value[1];
                                if (v <= 0 || v == '-') {
                                    return "";
                                }
                                var text2 = params.data.value[4].substr(0, 4);
                                if (params.componentIndex == 0) {
                                    document.getElementById('dateText').innerHTML = text2;
                                }

                                var color = params.color;
                                var data = se.data;
                                var prevValue = data[data.length - 2].value[1];
                                if (prevValue == '-' && v != '-') {
                                    prevValue = v;
                                }

                                var rangeY = myChart.getModel().getComponent('yAxis').axis.scale._extent;
                                var totalY = rangeY[1] - rangeY[0];

                                var height = $('#main').height() * 0.82;
                                var top = (height - height * v / totalY) * 1;
                                prevValue = (height - height * prevValue / totalY) * 1;
                                var id = "#code_" + params.seriesName;

                                if ($(id).html() == "") {
                                    snabbt(document.getElementById("code_" + params.seriesName), {
                                        position: [0, prevValue, 0],
                                        easing: 'linear',
                                        duration: 0
                                    });
                                    $(id).html(params.seriesName + " " + v);
                                    $(id).attr("v", v);
                                    $(id).css("color", color);
                                }

                                var times = 50;
                                for (let i = 1; i <= times; i++) {
                                    setTimeout(function() {
                                        var old = parseFloat($(id).attr("v"));
                                        var split = (v - old) / times;
                                        var r = old + split;
                                        var fixed = 2;
                                        if (r > 1000) {
                                            fixed = 1;
                                        }
                                        if (r > 10000) {
                                            fixed = 0;
                                        }
                                        r = r.toFixed(fixed);
                                        $(id).html(params.seriesName + " " + r);
                                        $(id).attr("v", r);

                                    }, 1 * duration / times * i)
                                }

                                moveTime = moveTime * 0.999;

                                snabbt(document.getElementById("code_" + params.seriesName), {
                                    position: [0, top, 0],
                                    easing: 'linear',
                                    duration: 1 * duration * moveTime
                                });

                                return "";
                            }
                        }

                        try {
                            myChart.setOption(option);
                        } catch (error) {
                            console.log(error);
                        }


                    }, 1 * duration);
                }, 9 * duration);

            }
        });
    </script>
</body>

</html>
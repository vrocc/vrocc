<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>听投资者说 股票排行榜</title>
    <link rel="icon" href="//s3.ax1x.com/2021/02/10/y0Ky0P.png">
    <link rel="stylesheet" type="text/css" href="css/stock.css">
    <!-- 引入 ECharts 文件 -->
    <script src="//lib.baomitu.com/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/echarts@5.0.2/dist/echarts.min.js"></script>
    <script src="config/roma.js"></script>
    <script src="js/stock.js"></script>
</head>

<body>

    <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
    <div id="main" style="width: 1300px;height:700px;">
    </div>
    <div id="date">
        <div id="dateText"></div>
        <div id="brand">公众号：沉简投资</div>
        <div id="stockTip"></div>
    </div>
    <br><br><br>
    <iframe id="playIframe" frameborder="no" border="0" marginwidth="0" marginheight="0" width=298 height=52 src="//music.163.com/outchain/player?type=2&id=498320137&auto=1&height=32"></iframe>
    <div>
        <a href="/?codes=300896,300999,600009,000423,601318,601012,600519,600436&aniDura=1.2">
            ↑↑↑ 点击播放 雪球热股榜 - 2021年02月09日
        </a>
        <a href="/?codes=300896,BIDU,hk00700&aniDura=1.2">
            ↑↑↑ 点击播放 BAT 股价历史 - 2021年02月09日
        </a>
        <br>
        <a href="https://space.bilibili.com/114571152" target="_blank">B站 听投资者说</a>
    </div>
    <br>
    <img class="wechatQR" src="https://s3.ax1x.com/2021/02/10/yw6pO1.jpg" alt="一杯咖啡">
    <img class="wechatQR" src="https://s3.ax1x.com/2021/02/10/ywyhWQ.png" alt="公众号引导">


    <script type="text/javascript">
        $(document).ready(function() {
            var codes = getQueryString("codes");
            codes && (stockCodeArr = codes.split(","))

            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('main'), 'roma', {
                renderer: 'svg'
            });


            Promise.all(getStockInfo(stockCodeArr)).then(r => {
                console.log(r);
                var stockNameMap = new Map();
                var stockSharesMap = new Map();

                r.forEach(e => {
                    stockNameMap.set(e.symbol, e.name);
                    stockSharesMap.set(e.name, e.shares);
                })

                Promise.all(getStockKlineList(stockCodeArr)).then(result => {
                    var maxLen = 0;
                    result.forEach(e => {
                        var d = e.data;
                        if (!e.code) {
                            var symbol = d.symbol;
                            e.code = stockNameMap.get(symbol);
                        }
                        var items = d.items ? d.items : d.times;
                        var len = items.length
                        maxLen = len > maxLen ? len : maxLen;
                    })
                    var dateDim = 'month';
                    if (maxLen < 100) {
                        dateDim = 'day';
                    }

                    if (dateDim == 'month') {
                        print2View(result);
                    } else {
                        Promise.all(getStockKlineList(stockCodeArr, dateDim)).then(result => {
                            print2View(result);
                        });
                    }
                });
            });



            function print2View(result) {
                var tb = [
                    ["code", "time", "close"]
                ];
                var stockNames = [];
                var minDate = 1000000000;
                result.forEach(e => {
                    var stockName = e.data.name ? e.data.name : e.code;
                    if (stockName == undefined) {
                        stockName = stockNameMap.get(e.data.symbol);
                    }
                    stockNames.push(stockName);

                    var items = e.data.items ? e.data.items : e.data.times;
                    const ie = items[0];
                    var date = typeof ie == 'object' ? dateFormat("YYYYmmdd", new Date(ie.time)) : ie;
                    minDate = date < minDate ? date : minDate;

                    var initClose = 100;
                    for (let i = 0; i < items.length; i++) {
                        const ie = items[i];
                        var date = typeof ie == 'object' ? dateFormat("YYYYmmdd", new Date(ie.time)) : ie;

                        date = parseInt(date);
                        if (date == minDate) {
                            // initClose = ie;
                        }
                        if (date >= minDate) {
                            var close = 0;
                            if (typeof ie == 'object') {
                                close = ie.close;
                            } else {
                                close = e.data.closes[i];
                            }
                            tb.push([stockName, date, close]);
                        }
                    }

                });

                // 19961231 => Map(1) "SZSE000651" => Array(6) ["SZSE000651", 19961231, 76.98, 31607500, 1872172541, 1.610460251046025]
                var map = new Map();

                for (let i = 1; i < tb.length; i++) {
                    const e = tb[i];
                    var stockName = e[0];
                    var d = e[1];
                    var innerMap = map.get(d) || new Map();
                    innerMap.set(stockName, e);
                    map.set(d, innerMap)
                }
                var cur = new Map();
                var res = [
                    ["code", "time", "close"]
                ];
                var arrayObj = Array.from(map);
                arrayObj.sort(function(a, b) {
                    return a[0] - b[0]
                })
                map = new Map(arrayObj.map(i => [i[0], i[1]]));


                map.forEach(function(value, key) {
                    if (value.size < stockNames.length) {
                        stockNames.forEach(c => {
                            if (value.get(c) && !cur) {
                                var data = clone(cur.get(c));
                                data[1] = key;
                                var stockName = stockNameMap.get(c);
                                value.set(stockName, data);
                            }
                        })
                    }

                    var objs = value.values();
                    for (const it of objs) {
                        res.push(it);
                    }
                    cur = value;
                });

                view(res, map, stockNames, minDate);
            }

            var daysCount = 1000000;

            function view(raw, map, codes, minDate) {
                var timeBegin = new Date(minDate / 10000, minDate / 100 % 100, minDate % 100);
                timeBegin = timeBegin.addDays(daysCount);

                let keys = map.keys();
                let arr = [...keys];
                // let dateArr = [];
                // let dateArr2 = [];
                // for (let i = 0; i < arr.length; i++) {
                //     const e = arr[i];
                //     var itTime = new Date(e / 10000, e / 100 % 100, e % 100);
                //     arr[i] = '' + e;
                //     var dateStr = dateFormat('YYYY/mm/dd', itTime);
                //     if (itTime > timeBegin) {
                //         dateArr2.push(dateStr);;
                //     } else {
                //         dateArr.push(dateStr);
                //     }
                // }

                var rMap = new Map();
                var rMap2 = new Map();
                for (let i = 1; i < raw.length; i++) {
                    const e = raw[i];
                    var itTime = new Date(e[1] / 10000, e[1] / 100 % 100, e[1] % 100);

                    var dateStr = dateFormat('YYYY/mm/dd', itTime);


                    if (itTime > timeBegin) {
                        var innerArr = rMap2.get(e[0]);
                        if (innerArr) {
                            innerArr.push(
                                [dateStr, e[2], e[0], 1]
                            );
                        } else {
                            innerArr = new Array();
                            innerArr.push(
                                [dateStr, e[2], e[0], 0]
                            );
                        }
                        // codeName, List<Array> []
                        rMap2.set(e[0], innerArr)
                    } else {
                        var innerArr = rMap.get(e[0]);
                        if (innerArr) {
                            innerArr.push(
                                [dateStr, e[2], e[0], 1]
                            );
                        } else {
                            innerArr = new Array();
                            innerArr.push(
                                [dateStr, e[2], e[0], 0]
                            );
                        }
                        // codeName, List<Array> []
                        rMap.set(e[0], innerArr)
                    }
                }
                // console.log("rMap", rMap);

                var seriesList = [];
                var field = '价格';
                var lineWidth = 5;
                if (stockCodeArr.length > 3) {
                    lineWidth = 4.5;
                } else if (stockCodeArr.length > 2) {
                    lineWidth = 2;
                } else {
                    lineWidth = 1.8;
                }

                rMap.forEach(function(value, key) {
                    // console.log(key, value);
                    seriesList.push({
                        type: 'line',
                        name: key,
                        showSymbol: false,
                        smooth: true,
                        endLabel: {
                            show: true,
                            color: 'inherit',
                            // fontFamily: 'serif',
                            fontSize: 20,
                            // fontWeight: 'bolder',
                            formatter: function(params) {
                                var text = ('' + params.value[0]).substr(0, 4);
                                var text2 = params.data[0].substr(0, 4);
                                console.log(params.componentIndex, text, text2);
                                if (params.componentIndex == 0) {
                                    document.getElementById('dateText').innerHTML = text;
                                }

                                if (params.value[3] == 0) {
                                    return "";
                                } else {
                                    var tip = params.value[2] + ' 上市';
                                    $("#stockTip").html(tip);
                                    return params.value[2] + ' ' + params.value[1];
                                }
                            }
                        },

                        labelLayout: {
                            moveOverlap: 'shiftY'
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        encode: {
                            x: 'time',
                            y: field,
                            label: ['code', field],
                            itemName: 'time',
                            tooltip: [field],
                        },
                        areaStyle: {
                            color: 'rgba(96,96,96,0.05)'
                        },

                        data: value,
                        itemStyle: {
                            normal: {
                                lineStyle: {
                                    width: lineWidth // 0.1的线条是非常细的了
                                }
                            }
                        },
                    });
                });
                // console.log("seriesList", seriesList);

                var datasetWithFilters = [];
                var dura = getQueryString('aniDura');
                dura = dura ? dura : 4;
                var yAxisType = 'value';
                yAxisType = getQueryString('yt', yAxisType);

                option = {
                    backgroundColor: 'transparent',
                    animationDuration: dura * 60 * 1000,
                    animationThreshold: 1000000000,
                    animationDurationUpdate: dura * 60 * 1000 / 60 / 2,
                    animationEasingUpdate: 'line',
                    legend: {
                        icon: 'roundRect',
                        top: 'bottom',
                        selector: true
                            // orient: 'horizontal'
                    },
                    animation: true,
                    dateIndex: 0,
                    title: {
                        text: '听投资者说 股票排行榜',
                        subtext: '股价走势图(对数轴)',
                        subtextStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 25,
                        },
                        textStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 40,
                        },
                        left: "center",
                        top: "100",
                    },
                    tooltip: {
                        order: 'valueDesc',
                        trigger: 'axis'
                    },
                    xAxis: [{
                        type: 'category', //把value改成了category
                        scale: true,
                        // data: dateArr //时间格式，如2016年4月1日
                    }],
                    yAxis: {
                        type: yAxisType,
                        logBase: 5,
                        name: field,
                        nameTextStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 20,
                        },
                        // min: '0%',
                        // max: 'dataMax',
                    },
                    grid: {
                        right: 180
                    },
                    // series: seriesList,
                    series: seriesList,

                };

                myChart.setOption(option);
                var i = daysCount;
                setInterval(() => {
                    const e = raw[i];
                    rMap;
                    i++;
                    var cur = map.get(e[1]);
                    seriesList;
                    var seriesMap = new Map(seriesList.map(i => [i.name, i.data]));
                    var curArr = seriesMap.get(e[0]);

                    var itTime = new Date(e[1] / 10000, e[1] / 100 % 100, e[1] % 100);
                    var dateStr = dateFormat('YYYY/mm/dd', itTime);

                    if (curArr) {
                        //
                        curArr.push(
                            [dateStr, e[2], e[0], 1]
                        );
                    } else {
                        curArr = new Array();
                        curArr.push(
                            [dateStr, e[2], e[0], 0]
                        );
                    }


                    // seriesList.push({
                    //     type: 'line',
                    //     name: e.name,
                    //     data: curArr
                    // })

                    // myChart.setOption({
                    //     series: seriesList
                    // });
                }, dura * 60 * 1000 / 60 / 2);

                for (let i = 0; i < rMap.length; i++) {
                    const e = rMap[i];

                }
            }
        });
    </script>
</body>

</html>
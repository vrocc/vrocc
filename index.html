<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>听投资者说 股票排行榜</title>
    <link rel="icon" href="//s3.ax1x.com/2021/02/10/y0Ky0P.png">
    <link rel="stylesheet" type="text/css" href="css/stock.css">
    <!-- 引入 ECharts 文件 -->
    <script src="//lib.baomitu.com/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/echarts@5.0.2/dist/echarts.min.js"></script>
    <script src="config/roma.js"></script>
    <script src="js/numberAnimate.js"></script>
    <script src="js/snabbt.min.js"></script>
    <script src="js/stock.js"></script>
    <style>

    </style>
</head>

<body>

    <div id="mainTip">
    </div>
    <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
    <div id="main" style="width: 1500px;height:850px;">
    </div>
    <br>
    <div id="date" style="margin-top: -200px;">
        <div id="brand">公众号：沉简投资</div>
        <div id="dateText"></div>
    </div>
    <br><br>
    <br><br><br>
    <div>
        <a href="/?codes=300896,300999,600009,000423,601318,601012,600519,600436&aniDura=1.2">
            ↑↑↑ 点击播放 雪球热股榜 - 2021年02月09日
        </a>
        <a href="/?codes=BABA,BIDU,hk00700&aniDura=1.2">
            ↑↑↑ 点击播放 BAT 股价历史 - 2021年02月09日
        </a>
        <br>
        <a href="https://space.bilibili.com/114571152" target="_blank">B站 听投资者说</a>
    </div>
    <br>
    <img class="wechatQR" src="https://s3.ax1x.com/2021/02/10/yw6pO1.jpg" alt="一杯咖啡">
    <img class="wechatQR" src="https://s3.ax1x.com/2021/02/10/ywyhWQ.png" alt="公众号引导">


    <script type="text/javascript">
        $(document).ready(function() {
            // 基于准备好的dom，初始化echarts实例
            var codes = getQueryString("codes");
            codes && (stockCodeArr = codes.split(","))

            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('main'), 'roma', {
                renderer: 'svg'
            });


            Promise.all(getStockInfo(stockCodeArr)).then(r => {
                console.log(r);
                var stockNameMap = new Map();
                var stockSharesMap = new Map();
                var stockMarketValueMap = new Map();

                r.forEach(e => {
                    stockNameMap.set(e.symbol, e.name);
                    stockSharesMap.set(e.name, e.shares / 100000000.0);
                    // 汇率系数
                    var xs = 1.0;
                    var market = e.market;
                    if (market == "HK") {
                        xs = 0.8335;
                    } else if (market == "US") {
                        xs = 6.4622;
                    } else if (market == "UK") {
                        xs = 9.0601;
                    }
                    var mv = e.shares / 100000000.0 * xs;
                    // mv = parseFloat(mv.toFixed(2));
                    stockMarketValueMap.set(e.name, mv);
                })

                // 季度 quarter
                Promise.all(getStockKlineList(stockCodeArr, 'quarter')).then(result => {
                    var maxLen = 0;
                    result.forEach(e => {
                        var d = e.data;
                        if (!e.code) {
                            var symbol = d.symbol;
                            e.code = stockNameMap.get(symbol);
                        }
                        var items = d.items ? d.items : d.times;
                        var len = items.length
                        maxLen = len > maxLen ? len : maxLen;
                    })

                    var data = new Array();

                    result.forEach(e => {
                        var name = e.code;
                        var marketValue = stockMarketValueMap.get(name);
                        var items = e.data.items;
                        var values = new Array();
                        var times = new Array();
                        items.forEach(it => {
                            var value = it.close * marketValue;
                            value = value.toFixed(2);
                            values.push(parseFloat(value));
                            times.push(new Date(it.time));
                        })

                        data.push({
                            code: e.code,
                            values: values,
                            times: times
                        });

                    })


                    var dateDim = 'month';
                    // if (maxLen < 100) {
                    //     dateDim = 'day';
                    // }

                    // if (dateDim == 'month') {
                    print2View(data);
                    // } else {
                    //     Promise.all(getStockKlineList(stockCodeArr, dateDim)).then(result => {
                    //         print2View(result);
                    //     });
                    // }
                });
            });


            function print2View(result) {
                var tb = [
                    ["code", "time", "close"]
                ];
                var stockNames = [];
                result.forEach(e => {
                    var stockName = e.code;
                    if (stockName == undefined) {
                        stockName = stockNameMap.get(e.data.symbol);
                    }
                    stockNames.push(stockName);

                    for (let i = 0; i < e.times.length; i++) {
                        var date = e.times[i];
                        if (!date instanceof Date) {
                            date = parseInt(date);
                        }
                        var close = e.values[i];
                        tb.push([stockName, date, close]);
                    }

                });

                // 19961231 => Map(1) "SZSE000651" => Array(6) ["SZSE000651", 19961231, 76.98, 31607500, 1872172541, 1.610460251046025]
                var map = new Map();

                for (let i = 1; i < tb.length; i++) {
                    const e = tb[i];
                    var stockName = e[0];
                    var d = e[1];
                    var date = dateFormat("YYYYmmdd", d);
                    var innerMap = map.get(date) || new Map();
                    innerMap.set(stockName, e);
                    map.set(date, innerMap)
                }
                var cur = new Map();
                var res = [
                    ["code", "time", "close"]
                ];
                var arrayObj = Array.from(map);
                arrayObj.sort(function(a, b) {
                    return a[0] - b[0]
                });
                map = new Map(arrayObj.map(i => [i[0], i[1]]));

                // 0: {1960 => Map(2)}
                //     key: 1960
                //     value: Map(2)
                //     [[Entries]]
                //     0: {"中国" => Array(3)}
                //     1: {"印度" => Array(3)}
                // map = new Map(arrayObj.map(i => [i[0], i[1]]));
                // for (let i = 0; i < arrayObj.length; i++) {
                //     const date2Arr = arrayObj[i];
                //     var date = dateFormat("YYYYmmdd", date2Arr[0]);
                // }


                map.forEach(function(value, key) {
                    if (value.size < stockNames.length) {
                        stockNames.forEach(c => {
                            if (value.get(c) && !cur) {
                                var data = clone(cur.get(c));
                                data[1] = key;
                                var stockName = stockNameMap.get(c);
                                value.set(stockName, data);
                            }
                        })
                    }

                    var objs = value.values();
                    for (const it of objs) {
                        res.push(it);
                    }
                    cur = value;
                });

                view(res, map, stockNames);
            }

            function view(raw, map, codes) {
                var prev;
                var cl = 0;
                map.forEach(function(value, key) {
                    // value :{"格力电器" => Array(3)}
                    for (let i = 0; i < value.size; i++) {
                        const e = [...value.values()][i];
                        var length = value.size;
                        if (cl <= length) {
                            cl = length;
                            prev = key;
                        } else {
                            console.log(length);
                            // {"格力电器" => Array(3)}
                            var subMap = map.get(prev);
                            subMap.forEach(function(sv, sk) {
                                if (!value.get(sk)) {
                                    // key: 20200101
                                    var dateInt = parseInt(key);
                                    var date = new Date(dateInt / 10000, dateInt / 100 % 100 - 1, dateInt % 10);
                                    sv[1] = date;
                                    value.set(sv[0], sv);
                                }
                            })
                        }
                    }



                })

                let keys = map.keys();
                let arr = [...keys];

                // 名称 2 股票列表
                var stockNameToStockArrMap = getStockNameToStockArrMap(raw);
                var nameArr = [...stockNameToStockArrMap.keys()];

                // 生成相关的div节点
                for (let i = 0; i < nameArr.length; i++) {
                    const name = nameArr[i];
                    $("#mainTip").append('<div id="code_' + name + '"></div>');
                }

                // 这里不好，应该过滤前面的就可以
                var initValue = new Map();
                map.forEach(function(value, key) {
                    var length = value.size;
                    if (length < nameArr.length) {
                        // name, time, close
                        var infoArr = [...value.values()][0];
                        var sname = infoArr[0];
                        for (let i = 0; i < nameArr.length; i++) {
                            const name = nameArr[i];
                            if (name != sname) {
                                // 初始值
                                var initV = initValue.get(name);
                                var v = initV == undefined ? 0 : '-';
                                value.set(name, [name, infoArr[1], v]);
                                initValue.set(name, 1);
                            }
                        }
                    }
                });
                // var filteredItems = map.filter(function (item) {
                //     return value.size == nameArr.length;
                // });


                var seriesList = [];
                var field = '价格';
                var lineWidth = 1;
                for (let i = 0; i < nameArr.length; i++) {
                    const key = nameArr[i];
                    seriesList.push({
                        type: 'line',
                        name: key,
                        showSymbol: false,
                        hoverAnimation: false,
                        smooth: 0.05,
                        sampling: 'average',
                        endLabel: {
                            valueAnimation: true,
                            show: true,
                            color: 'inherit',
                            connectNulls: false,

                            fontSize: 20,
                            // fontWeight: 'bolder',
                            formatter: function(params) {
                                try {
                                    var value = params.data.value[1];
                                    var v = params.value[1];
                                    if (v <= 0) {
                                        return "";
                                    }
                                    return params.value[2] + ' ' + v;
                                } catch (error) {
                                    console.log(error);
                                }
                            }
                        },
                        data: new Array(),
                        itemStyle: {
                            normal: {
                                lineStyle: {
                                    width: lineWidth // 0.1的线条是非常细的了
                                },
                                areaStyle: {
                                    type: 'default',
                                },
                            },

                        },

                        areaStyle: { //区域填充样式
                            normal: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [{
                                        offset: 0,
                                        color: 'rgba(0, 175, 88, 0.4)',
                                    }, {
                                        offset: 1,
                                        color: 'rgba(0, 175, 88, 0.1)',
                                    }, ],
                                    globaCoord: false,
                                },
                            },
                        },
                    });
                }
                // 腾讯科技->Arr
                var count = 5 < map.size ? 5 : map.size;
                var seriesMap = new Map(seriesList.map(i => [i.name, i.data]));
                for (let i = 0; i < count; i++) {
                    var valueArr = [...map.values()]
                    var oneDayDataMap = valueArr[i];

                    oneDayDataMap.forEach(function(value, key) {
                        // value:[0: "腾讯控股", 1: 20040601, 2: 0.813]
                        var curArr = seriesMap.get(key);
                        var itTime = value[1];
                        // curArr.push(
                        //     [itTime, value[2], value[0], curArr.length]
                        // );

                        var now = new Date(itTime);
                        var dateStr = [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/');
                        var obj = {
                            name: now.toString(),
                            value: [
                                now,
                                value[2],
                                value[0],
                                curArr.length,
                                dateStr
                            ]
                        };
                        curArr.push(obj);
                    });
                }




                var colors = ['#FD2446', '#248EFD', '#C916F2', '#6669B1'];

                var cost = getQueryString("cost", 1);
                var duration = 1000 * cost;

                option = {
                    title: {
                        text: '听投资者说 股票排行榜',
                        subtext: '股价走势图',
                        subtextStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 25,
                        },
                        textStyle: {
                            color: '#233',
                            fontFamily: 'serif',
                            fontSize: 40,
                        },
                        left: "center",
                        top: "100",
                        show: false
                    },
                    xAxis: {
                        name: 'Year',
                        type: 'time',
                        splitLine: {
                            show: false
                        },
                        // boundaryGap: [0, '20%'],
                        // max: function(value) {
                        //     return value.max * 1.15;
                        // }
                    },
                    yAxis: [{
                        scale: false,
                        minInterval: 1,
                        axisLabel: {
                            inside: true,
                            margin: 10,
                            lineHeight: 0,
                        },
                        position: 'left',
                        offset: 0,
                        type: 'value',
                        name: '市值/亿RMB',
                        splitLine: {
                            show: false
                        },
                        axisLine: {
                            show: true
                        },
                        axisTick: {
                            show: true
                        },
                        axisLabel: {
                            formatter: '{value}'
                        },
                        zlevel: 100,
                        axisPointer: {
                            show: true,
                            type: 'line',
                            lineStyle: {
                                color: '#eee'
                            }
                        },
                        max: function(params) {
                            // if (params.max < 800) {
                            //     return 1000;
                            // }
                            return Math.round(params.max * 1.3);
                        }
                    }],
                    series: seriesList,
                    animationDuration: 10 * duration,
                    animationEasing: 'linear',
                    animationDurationUpdate: 1 * duration,
                    animationEasingUpdate: 'linear',
                    // animationDelayUpdate: function(idx) {
                    //     // 越往后的数据延迟越大
                    //     return idx * 100;
                    // },
                };

                try {
                    myChart.setOption(option);
                } catch (error) {
                    console.log(error);
                }


                var i = count;
                var moveTime = 1;
                setTimeout(() => {
                    var st = setInterval(() => {
                        var valueArr = [...map.values()]
                        var oneDayDataMap = valueArr[i];
                        i++;
                        if (!oneDayDataMap) {
                            clearInterval(st);
                            return;
                        }
                        oneDayDataMap.forEach(function(value, key) {
                            // value:[0: "腾讯控股", 1: 20040601, 2: 0.813]
                            var curArr = seriesMap.get(key);
                            var itTime = value[1];
                            // curArr.push(
                            //     [itTime, value[2], value[0], curArr.length]
                            // );

                            var now = new Date(itTime);
                            var dateStr = [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/');

                            var length = curArr.length;

                            var obj = {
                                name: now.toString(),
                                value: [
                                    now,
                                    value[2],
                                    value[0],
                                    length,
                                    dateStr
                                ]
                            };
                            curArr.push(obj);
                            if (curArr.length > 80) {
                                curArr.shift();
                            }
                            // curArr
                        });

                        for (let j = 0; j < seriesList.length; j++) {
                            const se = seriesList[j];
                            se.endLabel.formatter = function(params) {
                                var v = params.value[1];
                                if (v <= 0 || v == '-') {
                                    return "";
                                }
                                var text2 = params.data.value[4].substr(0, 4);
                                if (params.componentIndex == 0) {
                                    document.getElementById('dateText').innerHTML = text2;
                                }

                                var color = params.color;
                                var data = se.data;
                                var prevValue = data[data.length - 2].value[1];
                                if (prevValue == '-' && v != '-') {
                                    prevValue = v;
                                }

                                var rangeY = myChart.getModel().getComponent('yAxis').axis.scale._extent;
                                var totalY = rangeY[1] - rangeY[0];
                                var top = (520 - 520 * v / totalY) * 1.38;
                                prevValue = (520 - 520 * prevValue / totalY) * 1.38;
                                var id = "#code_" + params.seriesName;

                                if ($(id).html() == "") {
                                    snabbt(document.getElementById("code_" + params.seriesName), {
                                        position: [0, prevValue, 0],
                                        easing: 'linear',
                                        duration: 0
                                    });
                                    $(id).html(params.seriesName + " " + v);
                                    $(id).attr("v", v);
                                    $(id).css("color", color);
                                }

                                var times = 50;
                                for (let i = 1; i <= times; i++) {
                                    setTimeout(function() {
                                        var old = parseFloat($(id).attr("v"));
                                        var split = (v - old) / times;
                                        var r = old + split;
                                        r = r.toFixed(2);
                                        $(id).html(params.seriesName + " " + r);
                                        $(id).attr("v", r);

                                    }, 1 * duration / times * i)
                                }

                                moveTime = moveTime * 0.999;

                                snabbt(document.getElementById("code_" + params.seriesName), {
                                    position: [0, top, 0],
                                    easing: 'linear',
                                    duration: 1 * duration * moveTime
                                });

                                return "";
                            }
                        }

                        try {
                            myChart.setOption(option);
                        } catch (error) {
                            console.log(error);
                        }


                    }, 1 * duration);
                }, 9 * duration);

            }
        });
    </script>
</body>

</html>